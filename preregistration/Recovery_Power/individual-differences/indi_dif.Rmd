---
title: "phs-hierarchical"
author: "A.G. Mitchell"
date: "2024-10-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(bayesplot, brms, cmdstanr, extraDistr, furrr, ggplot2, pracma, tidyverse)

# adding functions to path
sapply(list.files(here::here("analysis","functions"), full.names = T), source)
source(here::here("preregistration","Recovery_Power", 'power_parameter_scripts.R'))

```


# first we get the two datasets:

```{r}
n_sim = 2

# correlated slope and threshold for phs

age_int_coeff = rnorm(n_sim,0.1,0.05)

age_slopes_coeff = rnorm(n_sim,-0.05,0.025)

age_rt_coeff = rnorm(n_sim,0.15,0.075) #response time increases with age
age_conf_coeff = rnorm(n_sim,-0.1,0.05) #confidence decreases with age


mu_int_phs = rnorm(n_sim,4.1,0.25) 
tau_int_phs = abs(rnorm(n_sim, 0.3,0.1))


mu_slope_phs = rnorm(n_sim,-1.5,0.5)

mu_int_rt = rnorm(n_sim, -1, 0.2)
mu_int_conf = rnorm(n_sim, 0.9, 0.2)

mu_slopes_rt = rnorm(n_sim,1,0.25)
mu_slopes_conf = rnorm(n_sim,-2,0.5)

mu_sigma_rt = rnorm(n_sim,-1,0.25)
mu_prec_conf = log(rnorm(n_sim,20,2))

mu_int_g = rnorm(n_sim, -5,1)
mu_int_l = rnorm(n_sim, 0,0.25)

mu_cut0 = rnorm(n_sim, -4,0.25)
mu_cut1 = rnorm(n_sim, 2,0.25)

mu_slopes1_rt = rnorm(n_sim,0,0.005)
mu_slopes1_conf = rnorm(n_sim,0,0.005)


tau_slopes1_rt = abs(rnorm(n_sim,0,0.005))
tau_slopes1_conf = abs(rnorm(n_sim,0,0.005))

tau_int_rt = abs(rnorm(n_sim, 0.2, 0.2))

tau_int_conf = abs(rnorm(n_sim, 0.2, 0.2))

tau_slopes_rt = abs(rnorm(n_sim,0.25,0.25))
tau_slopes_conf = abs(rnorm(n_sim,0.5,0.5))

tau_sigma_rt = abs(rnorm(n_sim,0.5,0.5))
tau_prec_conf = abs(rnorm(n_sim,0.5,0.5))

tau_int_g = abs(rnorm(n_sim, 0.5,0.5))
tau_int_l = abs(rnorm(n_sim, 0.25,0.25))

tau_cut0 = abs(rnorm(n_sim, 0.25,0.25))
tau_cut1 = abs(rnorm(n_sim, 0.25,0.25))

tau_slope_phs = abs(rnorm(n_sim, 1,0.2))

mu_ndt_rt = rnorm(n_sim,-2,1)
tau_ndt_rt = abs(rnorm(n_sim,0.1,1))


simulated_model = c(rep("model1",n_sim/2),rep("model2",n_sim/2))


parameters <- data.frame(
  mu_int_phs = mu_int_phs,
  mu_slope_phs = mu_slope_phs,
  mu_int_g = mu_int_g,
  mu_int_l = mu_int_l,
  
  mu_int_rt = mu_int_rt,
  mu_slopes_rt = mu_slopes_rt,
  mu_slopes1_rt = mu_slopes1_rt,
  mu_sigma_rt = mu_sigma_rt,
  mu_ndt_rt = mu_ndt_rt,
  mu_int_conf = mu_int_conf,
  
  
  mu_slopes_conf = mu_slopes_conf, # Adjusting size
  mu_slopes1_conf = mu_slopes1_conf,
  mu_prec_conf = mu_prec_conf,
  mu_cut0 = mu_cut0,
  mu_cut1 = mu_cut1,
  

  
  tau_slopes1_rt = tau_slopes1_rt,
  tau_slopes1_conf = tau_slopes1_conf,
  tau_int_phs = tau_int_phs,
  tau_slope_phs = tau_slope_phs,
  tau_int_l = tau_int_l,
  tau_int_g = tau_int_g,

  tau_int_rt = tau_int_rt,
  tau_slopes_rt = tau_slopes_rt,
  tau_sigma_rt = tau_sigma_rt,
  tau_int_conf = tau_int_conf,
  tau_slopes_conf = tau_slopes_conf,
  tau_prec_conf = tau_prec_conf,
  tau_cut0 = tau_cut0,
  tau_cut1 = tau_cut1,
  tau_ndt_rt = tau_ndt_rt,
  
  
  age_int_coeff = age_int_coeff,
  age_slopes_coeff = age_slopes_coeff,
  age_rt_coeff = age_rt_coeff,
  age_conf_coeff = age_conf_coeff,

  
  sim_n = 1:n_sim,
  n_sub = 83,
  simulated_model = simulated_model
)


data_list = split(parameters, seq(nrow(parameters)))
```


# now we first the first dataset (model 1) to both models on a single subject basis.

```{r}
parameters = data_list[[1]]

if(parameters$simulated_model == "model1"){
 df = sim_data_m1(parameters)
}else if(parameters$simulated_model == "model2"){
 df = sim_data_m2(parameters)
}

seed = rnorm(1,0,10000)


if(sum(df$rt == 10) / nrow(df) > 0.02){
  return("Error")
}

loos = data.frame()

for(i in unique(df$id)){
  
  print(i)
  
  df1 = df %>% filter(id == i)
  
  df1 %>% pivot_longer(cols = c(phs,rt,conf)) %>% ggplot(aes(x = x, y = value))+geom_point()+facet_wrap(~name,scales = "free", ncol = 1)
  
  stanHmodel1 <- cmdstanr::cmdstan_model(here::here("preregistration","Recovery_Power","individual-differences","single_sub_stanmodels","m1_ss.stan")) 
  stanHmodel2 <- cmdstanr::cmdstan_model(here::here("preregistration","Recovery_Power","individual-differences","single_sub_stanmodels","m2_ss.stan")) 
  
    
  fit_m1 = stanHmodel1$sample(data = list(N = nrow(df1), 
                                        tcf = df1$x,
                                        phs = df1$phs,
                                        rt = df1$rt,
                                        conf = df1$conf,
                                        min_rt = unique(df1$min_rt)),
                          refresh = 100,
                          iter_warmup = 1000,
                          iter_sampling = 1000,
                          parallel_chains = 4,
                          adapt_delta = 0.99,
                          max_treedepth = 12,
                          init = 0)

  m1_loo = fit_m1$loo()
  
  fit_m2 = stanHmodel2$sample(data = list(N = nrow(df1), 
                                        tcf = df1$x,
                                        phs = df1$phs,
                                        rt = df1$rt,
                                        conf = df1$conf,
                                        min_rt = unique(df1$min_rt)),
                          refresh = 1000,
                          iter_warmup = 1000,
                          iter_sampling = 1000,
                          parallel_chains = 4,
                          adapt_delta = 0.99,
                          max_treedepth = 12,
                          init = 0)
  m2_loo = fit_m2$loo()
  
  loo_q = data.frame(loo::loo_compare(list(m1 = m1_loo,m2 = m2_loo))) %>% 
              rownames_to_column()%>% 
                rename(model = rowname)%>% arrange(model) %>% 
                mutate(simulated_model = parameters$simulated_model)
    
  
  
  diagnostics = data.frame(mean_div = c(max(fit_m1$diagnostic_summary()$num_divergent),max(fit_m2$diagnostic_summary()$num_divergent)),
                           mean_tree = c(max(fit_m1$diagnostic_summary()$num_max_treedepth),max(fit_m2$diagnostic_summary()$num_max_treedepth)),
                           pareto_k_over07 = c(sum(m1_loo$diagnostics$pareto_k > 0.7),
                                               sum(m2_loo$diagnostics$pareto_k > 0.7)),
                           model = c("m1","m2"),
                           id = i)

  loo = inner_join(loo_q,diagnostics)
  
  
  loos = rbind(loos,loo)
  
  
}
```

# results of model comparison:

```{r}
ll = loos %>% mutate(elpd_diff = ifelse(model == "m1", -elpd_diff,elpd_diff)) %>% filter(elpd_diff != 0)

id_arrange = ll %>% arrange(elpd_diff) %>% .$id

ll$id <- factor(ll$id, levels = id_arrange)


plot_model1 = ll %>% mutate(div = as.factor(ifelse(mean_div != 0,1,0)))%>% 
  ggplot(aes(y = id, x = elpd_diff, xmin = elpd_diff-2*se_diff, xmax = elpd_diff+2*se_diff, col = div))+geom_pointrange()+theme_classic()+
  xlab("favors model 1 ------------------------------------------ favors model 2")+geom_vline(xintercept = 0, linetype = 2)+
  ggtitle("model 1 was used for simulation")

  
```


# same but when the model is model 2
```{r}
parameters2 = data_list[[2]]

if(parameters2$simulated_model == "model1"){
 df = sim_data_m1(parameters2)
}else if(parameters2$simulated_model == "model2"){
 df2 = sim_data_m2(parameters2)
}


if(sum(df2$rt == 10) / nrow(df2) > 0.02){
  return("Error")
}

loos2 = data.frame()

for(i in unique(df2$id)){
  
  print(i)
  
  df1 = df2 %>% filter(id == i)
  
  df1 %>% pivot_longer(cols = c(phs,rt,conf)) %>% ggplot(aes(x = x, y = value))+geom_point()+facet_wrap(~name,scales = "free", ncol = 1)
  
  stanHmodel1 <- cmdstanr::cmdstan_model(here::here("preregistration","Recovery_Power","individual-differences","single_sub_stanmodels","m1_ss.stan")) 
  stanHmodel2 <- cmdstanr::cmdstan_model(here::here("preregistration","Recovery_Power","individual-differences","single_sub_stanmodels","m2_ss.stan")) 
    
    
  fit_m1 = stanHmodel1$sample(data = list(N = nrow(df1), 
                                        tcf = df1$x,
                                        phs = df1$phs,
                                        rt = df1$rt,
                                        conf = df1$conf,
                                        min_rt = unique(df1$min_rt)),
                          refresh = 100,
                          iter_warmup = 1000,
                          iter_sampling = 1000,
                          parallel_chains = 4,
                          adapt_delta = 0.99,
                          max_treedepth = 12,
                          init = 0)

  m1_loo = fit_m1$loo()
  
  fit_m2 = stanHmodel2$sample(data = list(N = nrow(df1), 
                                        tcf = df1$x,
                                        phs = df1$phs,
                                        rt = df1$rt,
                                        conf = df1$conf,
                                        min_rt = unique(df1$min_rt)),
                          refresh = 100,
                          iter_warmup = 1000,
                          iter_sampling = 1000,
                          parallel_chains = 4,
                          adapt_delta = 0.99,
                          max_treedepth = 12,
                          init = 0)
  m2_loo = fit_m2$loo()
  
  loo_q = data.frame(loo::loo_compare(list(m1 = m1_loo,m2 = m2_loo))) %>% 
              rownames_to_column()%>% 
                rename(model = rowname)%>% arrange(model) %>% 
                mutate(simulated_model = parameters$simulated_model)
    
  
  
  diagnostics = data.frame(mean_div = c(max(fit_m1$diagnostic_summary()$num_divergent),max(fit_m2$diagnostic_summary()$num_divergent)),
                           mean_tree = c(max(fit_m1$diagnostic_summary()$num_max_treedepth),max(fit_m2$diagnostic_summary()$num_max_treedepth)),
                           pareto_k_over07 = c(sum(m1_loo$diagnostics$pareto_k > 0.7),
                                               sum(m2_loo$diagnostics$pareto_k > 0.7)),
                           model = c("m1","m2"),
                           id = i)

  loo = inner_join(loo_q,diagnostics)
  
  
  loos2 = rbind(loos2,loo)
  
  
}
```

#results of model_comparison

```{r}
ll = loos2 %>% mutate(elpd_diff = ifelse(model == "m1", -elpd_diff,elpd_diff)) %>% filter(elpd_diff != 0)

id_arrange = ll %>% arrange(elpd_diff) %>% .$id

ll$id <- factor(ll$id, levels = id_arrange)


plot_model2 = ll %>% mutate(div = as.factor(ifelse(mean_div != 0,1,0)))%>% 
  ggplot(aes(y = id, x = elpd_diff, xmin = elpd_diff-2*se_diff, xmax = elpd_diff+2*se_diff, col = div))+geom_pointrange()+theme_classic()+
  xlab("favors model 1 ------------------------------------------ favors model 2")+geom_vline(xintercept = 0, linetype = 2)+
  ggtitle("model 2 was used for simulation")
  
```

#combine the two ..

```{r,fig.width=12,fig.height=8}
library(patchwork)
plot_model1 / plot_model2
```

## Model 1

## model on the estimate of thermal contrast on RT and conf while not reporting PHS (phs == 0):

```{r}

ids = df %>% group_by(id) %>% summarize(phs = sum(phs)) %>% filter(phs == 0) %>% .$id

data = data.frame()

for(i in ids){
  
   print(i)
  
  df1 = df %>% filter(id == i)
  
  # df1 %>% pivot_longer(cols = c(phs,rt,conf)) %>% ggplot(aes(x = x, y = value))+geom_point()+facet_wrap(~name,scales = "free", ncol = 1)
  
  
  stanHmodel1 <- cmdstanr::cmdstan_model(here::here("preregistration","Recovery_Power","individual-differences","single_sub_stanmodels","m1_ss.stan")) 

  
    
  fit_m1 = stanHmodel1$sample(data = list(N = nrow(df1), 
                                        tcf = df1$x,
                                        phs = df1$phs,
                                        rt = df1$rt,
                                        conf = df1$conf,
                                        min_rt = unique(df1$min_rt)),
                          refresh = 100,
                          iter_warmup = 1000,
                          iter_sampling = 1000,
                          parallel_chains = 4,
                          adapt_delta = 0.99,
                          max_treedepth = 12,
                          init = 0)

  
  
  datas = data.frame(fit_m1$summary(c("b1_conf","b1_rt"))) %>% 
    mutate(id = i,
           max_div = max(fit_m1$diagnostic_summary()$num_divergent),
           max_tree = max(fit_m1$diagnostic_summary()$num_max_treedepth))
  
  data = rbind(data,datas)
}

df %>% filter(id %in% ids) %>% ggplot(aes(x = x,y = phs))+geom_point()+facet_wrap(~id)

data %>% ggplot(aes(y = id,x = mean,xmin = q5,xmax = q95))+geom_pointrange()+
  facet_wrap(~variable)+theme_classic()+geom_vline(xintercept = 0, linetype = 2)+
  ggtitle("model 1")

```




## Same for model 2

```{r}

ids2 = df2 %>% group_by(id) %>% summarize(phs = sum(phs)) %>% filter(phs == 0) %>% .$id

data2 = data.frame()

for(i in ids2){
  
   print(i)
  
  df1 = df %>% filter(id == i)
  
  
  
  stanHmodel2 <- cmdstanr::cmdstan_model(here::here("preregistration","Recovery_Power","individual-differences","single_sub_stanmodels","m2_ss.stan")) 

    
  fit_m1 = stanHmodel2$sample(data = list(N = nrow(df1), 
                                        tcf = df1$x,
                                        phs = df1$phs,
                                        rt = df1$rt,
                                        conf = df1$conf,
                                        min_rt = unique(df1$min_rt)),
                          refresh = 100,
                          iter_warmup = 1000,
                          iter_sampling = 1000,
                          parallel_chains = 4,
                          adapt_delta = 0.99,
                          max_treedepth = 12,
                          init = 0)

  
  
  datas = data.frame(fit_m1$summary(c("b1_conf","b1_rt"))) %>% 
    mutate(id = i,
           max_div = max(fit_m1$diagnostic_summary()$num_divergent),
           max_tree = max(fit_m1$diagnostic_summary()$num_max_treedepth))
  
  data2 = rbind(data2,datas)
}

df2 %>% filter(id %in% ids2) %>% ggplot(aes(x = x,y = phs))+geom_point()+facet_wrap(~id)

data2 %>% ggplot(aes(y = id,x = mean,xmin = q5,xmax = q95))+geom_pointrange()+facet_wrap(~variable)+
  theme_classic()+geom_vline(xintercept = 0, linetype = 2)+
  ggtitle("model 2")

```




## Now lets make it such that we get a model preference per age:

```{r}

parameters = data_list[[1]]

df_m1 = sim_data_m1(parameters)
df_m2 = sim_data_m2(parameters)


seed = rnorm(1,0,10000)


if(sum(df_m1$rt == 10) / nrow(df_m1) > 0.02){
  return("Error")
}

if(sum(df_m2$rt == 10) / nrow(df_m2) > 0.02){
  return("Error")
}

loos = data.frame()

for(i in unique(df_m1$id)){
  
  print(i)
  
  p_m1 = rbinom(1,1,i/83)
  
  if(p_m1 == 0){
    df1 = df_m1 %>% filter(id == i)
  }else if(p_m1 == 1){
    df1 = df_m2 %>% filter(id == i)
  }
  

  df1 %>% pivot_longer(cols = c(phs,rt,conf)) %>% ggplot(aes(x = x, y = value))+geom_point()+facet_wrap(~name,scales = "free", ncol = 1)
  

  stanHmodel1 <- cmdstanr::cmdstan_model(here::here("preregistration","Recovery_Power","individual-differences","single_sub_stanmodels","m1_ss.stan")) 
  stanHmodel2 <- cmdstanr::cmdstan_model(here::here("preregistration","Recovery_Power","individual-differences","single_sub_stanmodels","m2_ss.stan")) 
  
    
  fit_m1 = stanHmodel1$sample(data = list(N = nrow(df1), 
                                        tcf = df1$x,
                                        phs = df1$phs,
                                        rt = df1$rt,
                                        conf = df1$conf,
                                        min_rt = unique(df1$min_rt)),
                          refresh = 100,
                          iter_warmup = 1000,
                          iter_sampling = 1000,
                          parallel_chains = 4,
                          adapt_delta = 0.99,
                          max_treedepth = 12,
                          init = 0)

  m1_loo = fit_m1$loo()
  
  fit_m2 = stanHmodel2$sample(data = list(N = nrow(df1), 
                                        tcf = df1$x,
                                        phs = df1$phs,
                                        rt = df1$rt,
                                        conf = df1$conf,
                                        min_rt = unique(df1$min_rt)),
                          refresh = 100,
                          iter_warmup = 1000,
                          iter_sampling = 1000,
                          parallel_chains = 4,
                          adapt_delta = 0.99,
                          max_treedepth = 12,
                          init = 0)
  m2_loo = fit_m2$loo()
  
  loo_q = data.frame(loo::loo_compare(list(m1 = m1_loo,m2 = m2_loo))) %>% 
              rownames_to_column()%>% 
                rename(model = rowname)%>% arrange(model) %>% 
                mutate(simulated_model = p_m1)
    
  
  
  diagnostics = data.frame(mean_div = c(max(fit_m1$diagnostic_summary()$num_divergent),max(fit_m2$diagnostic_summary()$num_divergent)),
                           mean_tree = c(max(fit_m1$diagnostic_summary()$num_max_treedepth),max(fit_m2$diagnostic_summary()$num_max_treedepth)),
                           pareto_k_over07 = c(sum(m1_loo$diagnostics$pareto_k > 0.7),
                                               sum(m2_loo$diagnostics$pareto_k > 0.7)),
                           model = c("m1","m2"),
                           id = i)

  loo = inner_join(loo_q,diagnostics)
  
  
  loos = rbind(loos,loo)
  
  
}

loos


ll = loos %>% mutate(elpd_diff = ifelse(model == "m1", -elpd_diff,elpd_diff)) %>% filter(elpd_diff != 0)


plot_model2 = ll %>% mutate(div = as.factor(ifelse(mean_div != 0,1,0)))%>% filter(mean_div == 0) %>% 
  ggplot(aes(x = id, y = elpd_diff, ymin = elpd_diff-2*se_diff, ymax = elpd_diff+2*se_diff, col = as.factor(simulated_model)))+
  geom_pointrange()+theme_classic()

plot_model2

qq = ll %>% mutate(div = as.factor(ifelse(mean_div != 0,1,0)))%>% filter(mean_div == 0)

cor.test(qq$id,qq$elpd_diff)
```


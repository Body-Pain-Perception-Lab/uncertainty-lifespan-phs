---
title: "short_individual_dif report"
author: "Jesper F. E."
date: "2024-10-24"
output:
  html_document: default
  pdf_document: default
---

# Load packages and data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(bayesplot, brms, cmdstanr, extraDistr, furrr, ggpubr, ggplot2, pracma, 
               RColorBrewer, tidyverse,ggridges, patchwork,metR)


df <- read_csv(here::here("data","phs-ageing_compiled-filtered.csv")) %>% filter(catch == 0)

data_m1_nonresp = read.csv(here::here("analysis","objects","model2_nonresp.csv"))
data_m2_nonresp = read.csv(here::here("analysis","objects","model2_nonresp.csv"))

loos = readRDS(here::here("analysis","objects","individual_loos.rds"))

individual_params <- readRDS(here::here("analysis","objects", "individual_params.rds"))
individual_draws <- readRDS(here::here("analysis","objects", "individual_draws.rds"))

# palettes
pal_pg <- brewer.pal(11, 'PRGn')
pal_gr <- brewer.pal(9, 'Greens')
pal_pu <- brewer.pal(9, 'BuPu')
pal_or <- brewer.pal(8, 'OrRd')
pal_rd <- brewer.pal(8, 'Reds')
pal_bl <- brewer.pal(8, 'Blues')
```

```{r}

ageDat <- df %>% 
  group_by(subject) %>% 
  summarise(PHS_all = sum(PHS))

ll1 = loos %>% 
  mutate(elpd_diff = ifelse(model == "m1", -elpd_diff, elpd_diff)) %>% 
  filter(elpd_diff != 0)

id_arrange = ll1 %>% arrange(elpd_diff) %>% .$id
ll1$id <- factor(ll1$id, levels = id_arrange)
```

# negative values means that model 2 lost.

```{r}

plot_model1 = inner_join(ll1,ageDat) %>% 
  mutate(responder = as.factor(ifelse(PHS_all == 0, 1,0))) %>% 
  filter(mean_div == 0) %>%
  ggplot(aes(y = id, 
             x = elpd_diff, 
             xmin = elpd_diff-2*se_diff, 
             color = responder,
             fill = responder,
             xmax = elpd_diff+2*se_diff))+
  geom_pointrange(shape = 20, 
                  alpha = .7, 
                  # colour = pal_pu[8], 
                  # fill = pal_pu[8],
                  size = 0.5, linewidth = .7, show.legend = F)+
  scale_y_discrete(name = 'Participant')+
  scale_x_continuous(limits = c(-12,12), breaks = c(-10,0,10)) +
  labs(title = 'Winning model by participant') +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 1, colour = 'black')+
  scale_color_manual(values = c(pal_rd[7],pal_bl[7]))+
  theme_classic()+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 13),
        axis.title.x = element_blank(),
        axis.ticks.y = element_blank(),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        #plot.margin = margin(b = 1.5, unit = "cm"),
        #plot.margin = margin(b = 1, unit = "cm") #not needed when combined
        panel.border = element_rect(fill = NA, linewidth = 0.8)
        ) +
  #annotate("text", x = -6, y = -12, label = "Favours model 1", size = 4.5) +
  #annotate("text", x = 6, y = -12, label = "Favours model 2",  size = 4.5) +
  #geom_segment(x = -0.5, xend = -12, y = -8, yend=  -8, arrow = arrow(length = unit(4, "pt")))+
  #geom_segment(x = 0.5, xend = 12, y = -8, yend=  -8, arrow = arrow(length = unit(4, "pt")))+
  coord_cartesian(ylim = c(0, 75), clip = "off")

plot_model1
```


# Plot the correlation with age and model preference

```{r,echo=FALSE,warning=F}



plot_cor = inner_join(ll1,ageDat) %>% 
  mutate(responder = as.factor(ifelse(PHS_all == 0, 1,0))) %>% 
  filter(mean_div == 0) %>%
  ggplot(aes(y = (age-20), 
             x = elpd_diff, 
             xmin = elpd_diff-2*se_diff, 
             xmax = elpd_diff+2*se_diff,
             color = responder,
             fill = responder,
             group = age))+
  geom_pointrange(shape = 20, 
                  alpha = .7, 
                  # colour = pal_pu[8], 
                  # fill = pal_pu[8],
                  size = 0.5, linewidth = .7,
                  position = position_jitter(width = 0, height = .4, seed = 123),show.legend = F)+
  scale_y_continuous(name = 'Participant age',
                     breaks = c(0,20,40,60), labels = c('20','40','60','80')) +
  scale_x_continuous("ELPD difference",limits = c(-12,12), breaks = c(-10,0,10)) +
  labs(title = 'Winning model by age') +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 1, colour = 'black')+
  theme_classic()+
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title = element_text(size = 13),
        # axis.title.x = element_blank(),
        axis.ticks.y = element_blank(),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        panel.border = element_rect(fill = NA, linewidth = 0.8),
        plot.margin = margin(b = 1.5, r = 0.35, unit = "cm")
        #plot.margin = margin(b = 1, unit = "cm") #not needed when combined
        ) +
  scale_color_manual(values = c(pal_rd[7],pal_bl[7]))+
  annotate("text", x = -7.5, y = -14-8, label = "True perceiver", size = 4) +
  annotate("text", x = 9, y = -14-8, label = "Unsure perceiver",  size = 4) +
  geom_segment(x = -0.5, xend = -12, y = -10-8, yend= -10-8, arrow = arrow(length = unit(4, "pt")), col = "black")+
  geom_segment(x = 0.5, xend = 12, y = -10-8, yend=  -10-8, arrow = arrow(length = unit(4, "pt")), col = "black")+
  coord_cartesian(ylim = c(-1, 60), clip = "off")

plot_cor
```
# For the Subject level fits:
```{r}
ageDat <- df %>% 
  group_by(subject) %>% 
  summarise(PHS_all = sum(PHS))
df1 = left_join(df, ageDat, by = c('subject'))

winning_models = loos %>% 
  filter(elpd_diff == 0) %>% 
  select(model,age,id,pareto_k_over07) %>% 
  dplyr::rename(winning_model = model)

ss_param = inner_join(inner_join(individual_params,winning_models),df1 %>% 
             select(subject,PHS_all) %>% 
               distinct()) %>%  
  mutate(non_resp = ifelse(PHS_all == 0, 1, 0))

name_map <- c(
  "mus_phs[1]" = "a_phs",
  "mus_phs[2]" = "b_phs",
  "mus_phs[3]" = "g_phs",
  "mus_phs[4]" = "l_phs",
  "mus_rt[1]" = "a_rt",
  "mus_rt[2]" = "b_rt",
  "mus_rt[3]" = "b1_rt",
  "mus_rt[4]" = "sigma_rt",
  "mus_rt[5]" = "ndt_uc",
  "mus_conf[1]" = "a_conf",
  "mus_conf[2]" = "b_conf",
  "mus_conf[3]" = "b1_conf",
  "mus_conf[4]" = "phi_conf",
  "mus_conf[5]" = "c0_conf",
  "mus_conf[6]" = "c1_conf"
)

# Replace values in the 'param' column
ss_param <- ss_param %>%
  mutate(variable = recode(variable, !!!name_map))
```

```{r}
aphs_dat = ss_param %>% 
  filter(model == winning_model & variable == "a_phs") %>% 
  group_by(subject,PHS_all) %>% 
  arrange(PHS_all) %>% 
  mutate(subject = as.factor(subject))
aphs_dat$count = 1:length(aphs_dat$subject)

aphs_dat %>% 
  ggplot(aes(y = count,
             x = exp(mean)/100,
             xmin = exp(q5)/100,#a_phs[, "lower"]/100,
             xmax = exp(q95)/100,#a_phs[, "upper"]/100,
             colour = as.factor(non_resp),
             group = PHS_all)) +
  geom_pointrange(shape = 20, size = 0.5, linewidth = 0.7, alpha = .7, show.legend = F) +
  scale_colour_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7])) +
  scale_y_continuous(name = 'Total PHS per participant', breaks = c(12,75), labels = c('1','40')) +
  scale_x_continuous(name = 'PHS threshold', limits = c(0,1.6),
                     breaks = c(0,.5,1,1.5), labels = c('0','.5','1','1.5')) +
  # facet_wrap(~variable)+
  theme_classic() + 
  theme(legend.position = 'none',
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        axis.title = element_text(size = 13),
        axis.text = element_text(size = 11),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        panel.border = element_rect(fill = NA, linewidth = 1.2),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank()
        ) -> aphs_plot


group_aphs = aphs_dat %>% 
  mutate(resp = (non_resp-1)*-1) %>% #changing around so non resp on the bottom
  ggplot(aes(x = exp(mean)/100, y = as.factor(resp), fill = as.factor(resp), colour = as.factor(resp))) +
    geom_density_ridges(scale = 0.95, rel_min_height = 0.009, alpha = .5)+
    stat_summary(geom = "pointrange", linewidth = .75, size = .4) +
    scale_fill_manual(labels = c('PHS non-responder', 'PHS responder'),
                                 values = c(pal_bl[6], pal_rd[6]))+
    scale_colour_manual(labels = c('PHS non-responder', 'PHS responder'),
                                 values = c(pal_bl[7], pal_rd[7]))+
    scale_x_continuous(name = 'PHS threshold', limits = c(-0.1,1.6),
                     breaks = c(0,.5,1,1.5), labels = c('0','.5','1','1.5')) +
    scale_y_discrete(expand = c(0.1,0), limits = c('0','1','2')) +
    theme_classic()+
    theme(legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 11),
    axis.title.x = element_text(size = 13,vjust = 0.05),
    # axis.title.x = element_blank(),
    axis.text = element_text(size = 11),
    plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
    panel.border = element_rect(fill = NA, linewidth = 1.2),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line.y = element_blank())

aphs <- (aphs_plot / group_aphs + plot_layout(heights = c(4, 1)))
aphs
```


```{r}
b1rt_dat = ss_param %>% 
  filter(model == winning_model & variable == "b1_rt") %>% 
  group_by(subject,PHS_all) %>% 
  arrange(PHS_all) %>% 
  mutate(subject = as.factor(subject))
b1rt_dat$count = 1:length(b1rt_dat$subject)
  
  
b1rt_dat %>% ggplot(aes(y = count,
             x = (mean),
             xmin = (q5),#a_phs[, "lower"]/100,
             xmax = (q95),#a_phs[, "upper"]/100,
             colour = as.factor(non_resp),
             group = PHS_all)) +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.9) +
  geom_pointrange(shape = 20, size = 0.5, linewidth = 0.7, alpha = .7, show.legend = F) +
  scale_colour_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7])) +
  scale_y_continuous(name = 'Total PHS per participant', breaks = c(12,75), labels = c('1','40')) +
  scale_x_continuous(name = '\u0394RT by TC', limits = c(-0.2,0.1), 
                       breaks = c(-0.2,-0.1,0,0.1), labels = c('-0.2','-0.1','0','0.1')) +
  theme_classic() + 
  theme(legend.position = 'none',
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        axis.title = element_text(size = 13),
        axis.text = element_text(size = 11),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        panel.border = element_rect(fill = NA, linewidth = 1.2),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank()) -> b1rt_plot

group_b1rt = b1rt_dat %>% 
  mutate(resp = (non_resp-1)*-1) %>% #changing around so non resp on the bottom
  ggplot(aes(x = mean, y = as.factor(resp), fill = as.factor(resp), colour = as.factor(resp))) +
    geom_density_ridges(scale = 0.95, rel_min_height = 0.01, alpha = .5)+
    stat_summary(geom = "pointrange", linewidth = .75, size = .4) +
    scale_fill_manual(labels = c('PHS non-responder', 'PHS responder'),
                                 values = c(pal_bl[6], pal_rd[6]))+
    scale_colour_manual(labels = c('PHS non-responder', 'PHS responder'),
                                 values = c(pal_bl[7], pal_rd[7]))+
    scale_x_continuous(name = '\u0394RT by TC', limits = c(-0.2,0.1), 
                       breaks = c(-0.2,-0.1,0,0.1), labels = c('-0.2','-0.1','0','0.1')) +
    scale_y_discrete(expand = c(0.1,0), limits = c('0','1','2')) +
    theme_classic()+
    theme(legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 11),
    axis.title.x = element_text(size = 13,vjust = 0.05),
    # axis.title.x = element_blank(),
    axis.text = element_text(size = 11),
    plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
    panel.border = element_rect(fill = NA, linewidth = 1.2),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line.y = element_blank())

b1rt <- (b1rt_plot / group_b1rt + plot_layout(heights = c(4, 1)))
b1rt
```




```{r}
b1conf_dat = ss_param %>% 
  filter(model == winning_model & variable == "b1_conf") %>% 
  mutate(mean = ifelse(subject == "sub-1001",NA,mean)) %>% 
  group_by(subject,PHS_all) %>% 
  arrange(PHS_all) %>% 
  mutate(subject = as.factor(subject))

b1conf_dat$count <- 1:length(b1conf_dat$subject)
  
b1conf_dat %>% ggplot(aes(y = count,
             x = (mean),
             xmin = (q5),#a_phs[, "lower"]/100,
             xmax = (q95),#a_phs[, "upper"]/100,
             colour = as.factor(non_resp),
             group = PHS_all)) +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.9) +
  geom_pointrange(shape = 20, size = 0.5, linewidth = 0.7, alpha = .7, show.legend = F) +
  scale_colour_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7])) +
  scale_y_continuous(name = 'Total PHS per participant', breaks = c(12,74), labels = c('1','40')) +
  scale_x_continuous(name = 'PHS threshold', limits = c(-0.1,0.4),
                     breaks = c(0,0.2,0.4), labels = c('0','0.2','0.4')) +
  theme_classic() + 
  theme(legend.position = 'none',
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        axis.title = element_text(size = 13),
        # axis.title.x = element_blank(),
        axis.text = element_text(size = 11),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        panel.border = element_rect(fill = NA, linewidth = 1.2),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank()) -> b1conf_plot

group_b1conf = b1conf_dat %>% 
  mutate(resp = (non_resp-1)*-1) %>% #changing around so non resp on the bottom
  ggplot(aes(x = mean, y = as.factor(resp), fill = as.factor(resp), colour = as.factor(resp))) +
    geom_density_ridges(scale = 0.95, rel_min_height = 0.01, alpha = .5)+
    stat_summary(geom = "pointrange", linewidth = .75, size = .4) +
    scale_fill_manual(labels = c('PHS non-responder', 'PHS responder'),
                                 values = c(pal_bl[6], pal_rd[6]))+
    scale_colour_manual(labels = c('PHS non-responder', 'PHS responder'),
                                 values = c(pal_bl[7], pal_rd[7]))+
    scale_x_continuous(name = '\u0394Confidence by TC', limits = c(-0.1,0.4),
                     breaks = c(0,0.2,0.4), labels = c('0','0.2','0.4')) +
    scale_y_discrete(expand = c(0.1,0), limits = c('0','1','2')) +
    theme_classic()+
    theme(legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 11),
    axis.title.x = element_text(size = 13,vjust = 0.05),
    # axis.title.x = element_blank(),
    axis.text = element_text(size = 11),
    plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
    panel.border = element_rect(fill = NA, linewidth = 1.2),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line.y = element_blank())

b1conf <- (b1conf_plot / group_b1conf + plot_layout(heights = c(4, 1)))
b1conf

```




# Arrange all


```{r}
fig6.1 <- (plot_model1 / plot_cor + plot_layout(heights = c(1, 1)))+
  plot_annotation(tag_levels = list(c("A.", "B.")))&
    theme(plot.tag = element_text(face = "bold"),
        plot.tag.position = c(0,0.97))

fig6.1


fig6.2 = (aphs | b1rt | b1conf)+
  plot_annotation(title = "Effects of Thermal Contrast (TC)")+
  plot_layout(widths = c(1.1,1, 1),
              heights = c(1.1,1.1,1.1),
              guides = "collect") & 
  plot_annotation(tag_levels = list(c("C."))) &
  theme(plot.tag = element_text(face = "bold"),
        plot.tag.position = c(0,1.0255),
        legend.position = "bottom",
        plot.title = element_text(size = 13, hjust = 0.5, vjust = -1.5, face = 'bold')
        )
  



figure6 = (wrap_elements(fig6.1) | wrap_elements(fig6.2)) + 
  plot_layout(widths = c(1,2))
  # plot_annotation(tag_levels = list(c("A.", "B.","C."))) &
  # theme(plot.tag = element_text(face = "bold"),
  #       plot.tag.position = c(0,0.97))
# 
#                     ncol = 3, nrow = 1,
#                     widths = c(1.1,1,1),
#                     common.legend = TRUE,
#                     legend = 'bottom'
# 
# fig6.2 <- ggarrange(aphs,b1rt,b1conf,
#                     ncol = 3, nrow = 1,
#                     widths = c(1.1,1,1),
#                     common.legend = TRUE,
#                     legend = 'bottom'
#                     )
# fig6.2
# 
# figure6 <- ggarrange(fig6.1, NA, fig6.2,
#                      ncol = 3, nrow = 1,
#                      widths =c(0.75,.02,1.2)
#                      #labels = c('A.',"",'B.')
#                      )
# figure6

ggsave(file.path(here::here('manuscript','figures', 'figure6.png')), figure6, device = NULL,
       width = 9.5, height = 8, dpi = 600)
```

# Group means by responder:
```{r}

group_level_singlesub = inner_join(individual_draws,winning_models) %>% 
  mutate(non_resp = as.factor(ifelse(subject %in% ids, 1,0))) %>% 
  filter(model == winning_model) %>% group_by(non_resp,.draw) %>% 
  summarize(a_phs = mean(a_phs)/100,
            b1_rt = mean(b1_rt),
            b1_conf = mean(b1_conf))





group_b1rt = group_level_singlesub %>% ggplot(aes(x = b1_rt, y = non_resp, fill = non_resp))+
  # geom_histogram(col = "black")+
    geom_density_ridges(scale = 0.95, draw_baseline = FALSE,rel_min_height = 0.02)+
    scale_fill_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7]))+
  scale_x_continuous(name = 'ΔRT by TC', limits = c(-0.2,0.05),
                   breaks = c(-0.2,0,0.05), labels = c('-0.2','0','0.05')) +
  theme_classic()+
    theme(legend.position = "none",
    legend.title = element_blank(),
    legend.text = element_text(size = 11),
    axis.title = element_text(size = 13),
    # axis.title.x = element_blank(),
    axis.text = element_text(size = 11),
    plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
    panel.border = element_rect(fill = NA, linewidth = 1.2),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line.y = element_blank())



group_b1conf = group_level_singlesub %>% ggplot(aes(x = b1_conf, y = non_resp, fill = non_resp))+
  # geom_histogram(col = "black")+
    geom_density_ridges(draw_baseline = FALSE,rel_min_height = 0.009,scale = 0.95)+
    scale_fill_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7]))+
    scale_x_continuous(name = 'ΔConf by TC', limits = c(-0.07,3),
                     breaks = c(-0.05,0,3), labels = c('-0.05','0','3')) +
  theme_classic()+
    theme(legend.position = "none",
    legend.title = element_blank(),
    legend.text = element_text(size = 11),
    axis.title = element_text(size = 13),
    # axis.title.x = element_blank(),
    axis.text = element_text(size = 11),
    plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
    panel.border = element_rect(fill = NA, linewidth = 1.2),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line.y = element_blank())


```


# combine
```{r, fig.height=7,fig.width=7}

(aphs_plot / group_aphs + plot_layout(heights = c(4, 1))) |
(b1rt_plot / group_b1rt + plot_layout(heights = c(4, 1))) |
(b1conf_plot / group_b1conf + plot_layout(heights = c(4, 1)))
```



# first show a_phs by PHS count
```{r}
aphs_dat <- dq %>% 
  group_by(subject,PHS_all) %>% 
  summarise(mean = mean(a_phs),
            q20 = quantile(a_phs, .20),
            q80 = quantile(a_phs, .80)) %>% 
  arrange(PHS_all) %>% 
  mutate(subject = as.factor(subject),
         n_resp = ifelse(PHS_all == 0, 1, 0))


aphs_dat$count = 1:length(aphs_dat$subject)

aphs_dat %>%
  ggplot(aes(y = count,
             x = mean/100,
             xmin = q20/100,#a_phs[, "lower"]/100,
             xmax = q80/100,#a_phs[, "upper"]/100,
             colour = as.factor(n_resp),
             group = PHS_all)) +
  geom_pointrange(shape = 20, size = 0.5, linewidth = 0.7, alpha = .7) +
  scale_colour_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7])) +
  scale_y_continuous(name = 'Total PHS per participant', breaks = c(12,74), labels = c('1','40')) +
  scale_x_continuous(name = 'PHS threshold', limits = c(0,1.2),
                     breaks = c(0,.5,1), labels = c('0','.5','1')) +
  theme_classic() + 
  theme(legend.position = 'none',
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        axis.title = element_text(size = 13),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 11),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        panel.border = element_rect(fill = NA, linewidth = 1.2)
        ) -> aphs_plot

aphs_dat %>% mutate(resp = (n_resp-1)*-1) %>% 
  ggplot(aes(x = mean/100, y = as.factor(resp),
            colour = as.factor(n_resp),
            fill = as.factor(n_resp))) +
  geom_density_ridges(scale = 0.75, rel_min_height = .002, alpha = .8) +
  scale_y_discrete(name = '', limits = c('0','1','1.1'), expand = c(0,.05)) +
  scale_x_continuous(name = 'PHS threshold', limits = c(0,1.2),
                     breaks = c(0,.5,1), labels = c('0','.5','1')) +
  scale_colour_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7])) +
  scale_fill_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[6], pal_bl[6])) +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.position = 'none',
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title = element_text(size = 13),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        plot.margin = margin(b = 1.5, unit = "cm"),
        #plot.margin = margin(b = 1, unit = "cm") #not needed when combined
        panel.border = element_rect(fill = NA, linewidth = 1.2) 
        ) -> aphs_sum_plot

t1 <- ggarrange(NA,aphs_sum_plot,NA,
                ncol = 3, nrow = 1,
                widths = c(.1,1,.05))
aphs <- ggarrange(aphs_plot, t1,
                  ncol = 1, nrow = 2,
                  heights = c(1.5,.6))

aphs
```
# now show b1_rt by PHS count, flagging non-responders
```{r}
b1rt_dat <- dq %>% 
  group_by(subject,PHS_all) %>% 
  summarise(mean = mean(b1_rt),
            q20 = quantile(b1_rt, .20),
            q80 = quantile(b1_rt, .80)) %>% 
  arrange(PHS_all) %>% 
  mutate(subject = as.factor(subject),
         n_resp = ifelse(PHS_all == 0, 1, 0))
b1rt_dat$count = 1:length(b1rt_dat$subject)

b1rt_dat %>% 
  ggplot(aes(y = count,
             x = mean,
             xmin = q20,
             xmax = q80,
             colour = as.factor(n_resp),
             group = PHS_all)) +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.9) +
  geom_pointrange(shape = 20, size = 0.5, linewidth = 0.7, alpha = .7) +
  scale_colour_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7])) +
  scale_y_continuous(name = 'Total PHS per participant', breaks = c(12,74), labels = c('1','40')) +
  scale_x_continuous(name = '\u0394RT by TC', limits = c(-.04,.02),
                     breaks = c(-.04,-.02,0,.02), labels = c('-.04','-.02','0','.02')) +
  theme_classic() + 
  theme(legend.position = 'none',
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        axis.title = element_text(size = 13),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 11),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        panel.border = element_rect(fill = NA, linewidth = 1.2)
        ) -> b1rt_plot

b1rt_dat %>% mutate(resp = (n_resp-1)*-1) %>% 
  ggplot(aes(x = mean, y = as.factor(resp),
            colour = as.factor(n_resp),
            fill = as.factor(n_resp))) +
  geom_density_ridges(scale = 0.75, rel_min_height = .002, alpha = .8) +
  scale_y_discrete(name = '', limits = c('0','1','1.1'), expand = c(0,.05)) +
  scale_x_continuous(name = '\u0394RT by TC', limits = c(-.04,.02),
                     breaks = c(-.04,-.02,0,.02), labels = c('-.04','-.02','0','.02')) +
  scale_colour_manual(labels = c('PHS non-responder', 'PHS responder'),
                                 values = c(pal_rd[7], pal_bl[7])) +
  scale_fill_manual(labels = c('PHS non-responder', 'PHS responder'),
                                 values = c(pal_rd[6], pal_bl[6])) +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.position = 'none',
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title = element_text(size = 13),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        plot.margin = margin(b = 1.5, unit = "cm"),
        #plot.margin = margin(b = 1, unit = "cm") #not needed when combined
        panel.border = element_rect(fill = NA, linewidth = 1.2) 
        ) -> b1rt_sum_plot

t2 <- ggarrange(NA,b1rt_sum_plot,NA,
                ncol = 3, nrow = 1,
                widths = c(.02,1,.02))
b1rt <- ggarrange(b1rt_plot, t2,
                  ncol = 1, nrow = 2,
                  heights = c(1.5,.6))

b1rt
```
# finally do the same for confidence
```{r}
b1conf_dat <- dq %>% 
  group_by(subject,PHS_all) %>% 
  summarise(mean = mean(b1_conf),
            q20 = quantile(b1_conf, .20),
            q80 = quantile(b1_conf, .80)) %>% 
  arrange(PHS_all) %>% 
  mutate(subject = as.factor(subject),
         n_resp = ifelse(PHS_all == 0, 1, 0))
b1conf_dat$count = 1:length(b1conf_dat$subject)

b1conf_dat %>% 
  ggplot(aes(y = count,
             x = mean,
             xmin = q20,
             xmax = q80,
             colour = as.factor(n_resp),
             group = PHS_all)) +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.9) +
  geom_pointrange(shape = 20, size = 0.5, linewidth = 0.7, alpha = .7) +
  scale_colour_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7])) +
  scale_y_continuous(name = 'Total PHS per participant', breaks = c(12,74), labels = c('1','40')) +
  scale_x_continuous(name = '\u0394Confidence by TC', limits = c(-.06,.06),
                     breaks = c(-.06,-.03,0,.03,.06), labels = c('-.06','-.03','0','.03','.06')) +
  theme_classic() + 
  theme(legend.title = element_blank(),
        legend.position = 'none',
        legend.text = element_text(size = 11),
        axis.title = element_blank(),
        axis.text = element_text(size = 11),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        panel.border = element_rect(fill = NA, linewidth = 1.2)
        ) -> b1conf_plot

b1conf_dat %>% mutate(resp = (n_resp-1)*-1) %>% 
  ggplot(aes(x = mean, y = as.factor(resp),
            colour = as.factor(n_resp),
            fill = as.factor(n_resp))) +
  geom_density_ridges(scale = 0.75, rel_min_height = .002, alpha = .8) +
  scale_y_discrete(name = '', limits = c('0','1','1.1'), expand = c(0,.05)) +
  scale_x_continuous(name = '\u0394Confidence by TC', limits = c(-.06,.06),
                     breaks = c(-.06,-.03,0,.03,.06), labels = c('-.06','-.03','0','.03','.06')) +
  scale_colour_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[7], pal_bl[7])) +
  scale_fill_manual(labels = c('PHS responder', 'PHS non-responder'),
                                 values = c(pal_rd[6], pal_bl[6])) +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.position = 'none',
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title = element_text(size = 13),
        plot.title = element_text(size = 13, hjust = 0.5, face = 'bold'),
        plot.margin = margin(b = 1.5, unit = "cm"),
        #plot.margin = margin(b = 1, unit = "cm") #not needed when combined
        panel.border = element_rect(fill = NA, linewidth = 1.2) 
        ) -> b1conf_sum_plot

t3 <- ggarrange(NA,b1conf_sum_plot,NA,
                ncol = 3, nrow = 1,
                widths = c(.02,1,.02))
b1conf <- ggarrange(b1conf_plot, t3,
                  ncol = 1, nrow = 2,
                  heights = c(1.5,.6))

b1conf
```
# compile plots
```{r}
fig6.2 <- ggarrange(aphs, b1rt, b1conf,
                    ncol = 3, nrow = 1,
                    widths = c(1.1,1,1),
                    legend = 'none')
fig6.2

ggsave(file.path(here::here('manuscript','figures', 'figure6B.png')), fig6.2, device = NULL,
       width = 6, height = 7, dpi = 600)
```

# Load the non-responders dataframe fits:
```{r, include=FALSE,echo=FALSE, warning=F}
data_m1_nonresp <- data_m1_nonresp %>% 
  mutate(variable = fct_recode(variable, 'confidence' = 'b1_conf',
                               'response time' = 'b1_rt'),
         variable = factor(variable, levels = c('response time','confidence'))
         )
data_m2_nonresp <- data_m2_nonresp %>% 
  mutate(variable = fct_recode(variable, 'confidence' = 'b1_conf',
                               'response time' = 'b1_rt'),
         variable = factor(variable, levels = c('response time','confidence'))
         )
```

# Plot the non-responder plots:

```{r, include=FALSE,echo=FALSE, warning=F}
nr1_plot <- data_m1_nonresp %>% 
  filter(max_div == 0) %>% 
  #mutate(outlier = ifelse(mean > 0.2,1,0)) %>% 
  ggplot(aes(y = id,x = mean,xmin = q5, xmax = q95))+
  geom_pointrange(shape = 21, 
                  alpha = .7, 
                  colour = pal_gr[8], 
                  fill = pal_gr[8])+
  facet_wrap(~variable, scales = "free")+
  geom_vline(xintercept = 0, linetype = 2)+
  labs(y = "", x = '', title = "Non-responders")+
  theme_classic()+
  theme(plot.title = element_text(hjust = .5, vjust = 2, size = 14),
        axis.title = element_text(size = 12),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

# plot model 2
nr2_plot <- data_m2_nonresp %>% 
  filter(max_div == 0) %>% 
  mutate(outlier = ifelse(mean > 0.2,1,0)) %>%
  ggplot(aes(y = id,x = mean,xmin = q5, xmax = q95))+
  geom_pointrange(shape = 21, 
                  alpha = .7, 
                  colour = pair_pal[1], 
                  fill = pair_pal[1])+
  facet_wrap(outlier~variable, scales = "free")+
  geom_vline(xintercept = 0, linetype = 2) +
  labs(y = "", x = 'Mean', title = "Fitted model 2")+
  theme_classic()+
  theme(axis.title = element_text(size = 12),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.title = element_blank())
# 
nr1_plot

nr2_plot
```

# identical that is good! So now we look at the draws from one of them to compute the grand average while account for the uncertainty in each subjects' estimates:


```{r}
draws = read.csv(here::here("analysis","objects","model1_nonresp_draws.csv"))

means_rt  = draws %>% filter(max_div == 0) %>% group_by(id) %>% mutate(draw = 1:n()) %>% ungroup() %>% 
  select(-c(X,max_div,max_tree,b1_conf)) %>% pivot_wider(names_from = id, values_from = c(b1_rt)) %>% select(-draw) %>% 
  rowwise() %>%
  mutate(Grand_avg = mean(c_across(everything()), na.rm = TRUE)) %>%
  ungroup()

means_conf  = draws %>% filter(max_div == 0) %>% group_by(id) %>% mutate(draw = 1:n()) %>% ungroup() %>% 
  select(-c(X,max_div,max_tree,b1_rt)) %>% pivot_wider(names_from = id, values_from = c(b1_conf)) %>% select(-draw) %>% 
  rowwise() %>%
  mutate(Grand_avg = mean(c_across(everything()), na.rm = TRUE)) %>%
  ungroup()
```


